<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Practitioner</title>
   </head>
   <body>
      <h2>Orientation</h2>
      <!-- <pre id="orientation"></pre> -->
      <canvas id="orientation" width="500" height="200"></canvas>
      <h2>Motion</h2>
      <!-- <pre id="motion"></pre> -->
      <canvas id="motion" width="500" height="200"></canvas>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
      <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3/dist/jquery.min.js,npm/socket.io-client@2.3/dist/socket.io.min.js"></script>
      <script src='https://meet.jit.si/external_api.js'></script>
      <script>
         var ctx_motion = document.getElementById('motion').getContext('2d');
         data_motion = {
                 labels: [0],
                 datasets: [{
                     label: 'acceleration_x',
                     borderColor: "Red",
                     data: [],
                 },{
                    label: 'acceleration_y',
                    borderColor: "Green",
                    data: [],
                 },{
                    label: 'acceleration_z',
                    borderColor: "Blue",
                    data: [],
                 }]
             }
         var chart_motion = new Chart(ctx_motion, {
             type: 'line',
             data: data_motion,
             options: {
                 responsive: false,
                 elements: {
                     point:{
                         radius: 0,
                     },
                     line: {
                                 fill: false
                         }
                 },
                 scales: {
                     yAxes: [{
                         ticks: {
                             beginAtZero: false
                         }
                     }]
                 },
                 animation: {
                     duration:0
                 }
             }
         });
         var ctx_orientation = document.getElementById('orientation').getContext('2d');
         data_orientation = {
                 labels: [0],
                 datasets: [{
                     label: 'alpha',
                     borderColor: "Red",
                     data: [],
                 },{
                    label: 'beta',
                    borderColor: "Green",
                    data: [],
                 },{
                    label: 'gamma',
                    borderColor: "Blue",
                    data: [],
                 }]
             }
         var chart_orientation = new Chart(ctx_orientation, {
             type: 'line',
             data: data_orientation,
             options: {
                 responsive: false,
                 elements: {
                     point:{
                         radius: 0,
                     },
                     line: {
                                 fill: false
                         }
                 },
                 scales: {
                     yAxes: [{
                         ticks: {
                             beginAtZero: false
                         }
                     }]
                 },
                 animation: {
                     duration:0
                 }
             }
         });
      </script>
      <script>
         const url = 'https://relay.equilibrium.fabianvillena.tk'; // Change to the URI of your Socket.io server
         const socket = io.connect( url, { reconnection: true } ); // Set false to disable automatic reconnection
         
         ;(function($) {
         
             // Initialize Socket.IO
             var socket_name = 'equilibrium'; // Name as you wish
             var orientation = $( '#orientation' );
             var motion = $( '#motion' );
         
             // Display connection state
             socket.on( 'connect', function() {
         
                 console.info( 'Connected: ' + socket_name );
         
             }).on( 'disconnect', function( reason ) {
         
                 console.info( 'Disconnected: ' + socket_name );
         
             });
         
             // Listen for messages from Socket.IO
             socket.on( socket_name, function( response ) {
         
                 console.log( `Received [${socket_name}]`, response );
         
                //  orientation.html( JSON.stringify(response.orientation, null, '\t') );
                //  motion.html( JSON.stringify(response.motion, null, '\t') );
                if ("motion" in response) {
                    data_motion.labels.push(data_motion.labels[data_motion.labels.length - 1] + 1)
                    if (data_motion.labels.length > 100) {
                        data_motion.labels.shift()
                    }
                    data_motion.datasets[0].data.push(response.motion.acceleration_x)
                    if (data_motion.datasets[0].data.length > 100) {
                        data_motion.datasets[0].data.shift()
                    }
                    data_motion.datasets[1].data.push(response.motion.acceleration_y)
                    if (data_motion.datasets[1].data.length > 100) {
                        data_motion.datasets[1].data.shift()
                    }
                    data_motion.datasets[2].data.push(response.motion.acceleration_z)
                    if (data_motion.datasets[2].data.length > 100) {
                        data_motion.datasets[2].data.shift()
                    }
                    chart_motion.update()
                }
                if ("orientation" in response) {
                    data_orientation.labels.push(data_orientation.labels[data_orientation.labels.length - 1] + 1)
                    if (data_orientation.labels.length > 100) {
                        data_orientation.labels.shift()
                    }
                    data_orientation.datasets[0].data.push(response.orientation.alpha)
                    if (data_orientation.datasets[0].data.length > 100) {
                        data_orientation.datasets[0].data.shift()
                    }
                    data_orientation.datasets[1].data.push(response.orientation.beta)
                    if (data_orientation.datasets[1].data.length > 100) {
                        data_orientation.datasets[1].data.shift()
                    }
                    data_orientation.datasets[2].data.push(response.orientation.gamma)
                    if (data_orientation.datasets[2].data.length > 100) {
                        data_orientation.datasets[2].data.shift()
                    }
                    chart_orientation.update()
                }
                
             });
           
         })( window.jQuery );
         
         
         
      </script>
    <script>
        $(document).ready(function(){
            const domain = 'meet.jit.si';
const options = {
    roomName: 'JitsiMeetAPIExample',
    width: 700,
    height: 700,
    parentNode: document.querySelector('#meet')
};
const api = new JitsiMeetExternalAPI(domain, options);
        });
    </script>
<div id="meet">
    meeting
</div>
      
<button id="myButton">Download</button>
<script>
   const objectToCsv = function(data) {
      const csvRows = [];
      const headers = Object.keys(data[0]);
      csvRows.push(headers.join(','));
      
       for(const row of data){
          const values = headers.map(header =>{
             return row[header]
             });
       }
   };
   
   const download = function(data) {
      const blob = new Blob([data], {type: 'text/csv'});
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('hidden', '');
      a.setAttribute('href', url);
      a.setAttribute('download', 'paciente.csv');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
   };

   const getReport = async function (){
      const json = response;
      const data = json.map( row => ({
         acceleration_x: row.acceleration_x,
         acceleration_y: row.acceleration_y,
         acceleration_z: row.acceleration_z
      }));
      
      const csvData = objectToCsv(data);
      download(csvData);
      };

(function() {
    // button click
    const button = document.getElementById('myButton');
    button.addEventListener('click', getReport);
})();

</script>
   </body>
</html>
