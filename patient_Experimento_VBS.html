<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Patient</title>

   </head>
   <body>
      <main role="main" class="container"></main>
      <div class="p-3 mb-2 bg-secondary" id="demo-div"></div>
      <p style="margin-top:1rem;">Num. of datapoints Listener: <span class="badge badge-warning" id="num-observed-events">0</span></p>
      <p style="margin-top:1rem;">Num. of datapoints HANDLED: <span class="badge badge-warning" id="num-handled-events">0</span></p>
      <p style="margin-top:1rem;">Date lastMove_orientation_Listener: <span class="badge badge-warning" id="date_lastMove_orientation_id">0</span></p>
      <p style="margin-top:1rem;">Date lastMove_motion_Listener: <span class="badge badge-warning" id="date_lastMove_motion_id">0</span></p>
      <p style="margin-top:1rem;">DateDiff lastMove_orientation_Listener_HANDLED: <span class="badge badge-warning" id="datediff_lastMove_orientation_HANDLED_id">0</span></p>
      <p style="margin-top:1rem;">DateDiff lastMove_motion_Listener_HANDLED: <span class="badge badge-warning" id="datediff_lastMove_motion_HADNLED_id">0</span></p>
      
      <h3>Datos Listened</h3>
      <h4>Orientation</h4>
      <ul>
         <li>X-axis (&beta;): <span id="Orientation_b">0</span><span>&deg;</span></li>
         <li>Y-axis (&gamma;): <span id="Orientation_g">0</span><span>&deg;</span></li>
         <li>Z-axis (&alpha;): <span id="Orientation_a">0</span><span>&deg;</span></li>
      </ul>
      
      <h4>Acceleration</h4>
      <ul>
         <li>X-axis: <span id="Accelerometer_x">0</span><span> m/s<sup>2</sup></span></li>
         <li>Y-axis: <span id="Accelerometer_y">0</span><span> m/s<sup>2</sup></span></li>
         <li>Z-axis: <span id="Accelerometer_z">0</span><span> m/s<sup>2</sup></span></li>
      </ul>

      <h4>Rotation</h4>
      <ul>
         <li>X-axis (&beta;): <span id="Rotation_b">0</span><span>&deg;</span></li>
         <li>Y-axis (&gamma;): <span id="Rotation_g">0</span><span>&deg;</span></li>
         <li>Z-axis (&alpha;): <span id="Rotation_a">0</span><span>&deg;</span></li>
      </ul>

      <h3>Datos Listened HANDLED</h3>
      <h4>Orientation-HANDLED</h4>
      <ul>
         <li>X-axis (&beta;): <span id="Orientation_b_HANDLED">0</span><span>&deg;</span></li>
         <li>Y-axis (&gamma;): <span id="Orientation_g_HANDLED">0</span><span>&deg;</span></li>
         <li>Z-axis (&alpha;): <span id="Orientation_a_HANDLED">0</span><span>&deg;</span></li>
      </ul>
      
      <h4>Acceleration-HANDLED</h4>
      <ul>
         <li>X-axis: <span id="Accelerometer_x_HANDLED">0</span><span> m/s<sup>2</sup></span></li>
         <li>Y-axis: <span id="Accelerometer_y_HANDLED">0</span><span> m/s<sup>2</sup></span></li>
         <li>Z-axis: <span id="Accelerometer_z_HANDLED">0</span><span> m/s<sup>2</sup></span></li>
      </ul>

      <h4>Rotation-HANDLED</h4>
      <ul>
         <li>X-axis (&beta;): <span id="Rotation_b_HANDLED">0</span><span>&deg;</span></li>
         <li>Y-axis (&gamma;): <span id="Rotation_g_HANDLED">0</span><span>&deg;</span></li>
         <li>Z-axis (&alpha;): <span id="Rotation_a_HANDLED">0</span><span>&deg;</span></li>
      </ul>

      <p>Experimento</p>
      <img src="dinosaurio.jpg">

      <script>
      function updateFieldIfNotNull(fieldName, value, precision=10){
         if (value != null)
            document.getElementById(fieldName).innerHTML = value.toFixed(precision);
         }  
      </script>

      <script>//ACA VAN LAS QUE ACTUALIZAN LOS DATOS EN TODO INSTANTE
      function handleOrientationWriteListener(event) {//Agregada por Víctor
      updateFieldIfNotNull('Orientation_b', event.beta);
      updateFieldIfNotNull('Orientation_g', event.gamma);
      updateFieldIfNotNull('Orientation_a', event.alpha);
      }

      function handleMotionWriteListener(event) {//Agregada por Víctor
      updateFieldIfNotNull('Accelerometer_x', event.acceleration.x);
      updateFieldIfNotNull('Accelerometer_y', event.acceleration.y);
      updateFieldIfNotNull('Accelerometer_z', event.acceleration.z);
      
      updateFieldIfNotNull('Rotation_b', event.rotationRate.beta);
      updateFieldIfNotNull('Rotation_g', event.rotationRate.gamma);
      updateFieldIfNotNull('Rotation_a', event.rotationRate.alpha);
      }
      </script>

      <script>//ACA SON LAS QUE SOLO ACTUALIZAN DATOS SEGUN UNA REGLA PARA NO ENVIAR MUCHOS

      var lastMove_orientation_HANDLED = 0;
      function handleOrientationWriteListener_HANDLED(event) {//Agregada por Víctor         
         document.getElementById("date_lastMove_orientation_id").innerHTML = lastMove_orientation_HANDLED;
         if(Date.now() - lastMove_orientation_HANDLED > 1000) {
            document.getElementById("datediff_lastMove_orientation_HANDLED_id").innerHTML = Date.now()-lastMove_orientation_HANDLED;
            updateFieldIfNotNull('Orientation_b_HANDLED', event.beta);
            updateFieldIfNotNull('Orientation_g_HANDLED', event.gamma);
            updateFieldIfNotNull('Orientation_a_HANDLED', event.alpha);
            lastMove_orientation_HANDLED = Date.now();
            }
         }

      var lastMove_motion_HANDLED = 0;
      function handleMotionWriteListener_HANDLED(event) {//Agregada por Víctor             
         document.getElementById("date_lastMove_motion_id").innerHTML = lastMove_motion_HANDLED;  
         if(Date.now() - lastMove_motion_HANDLED > 1000) {
            document.getElementById("datediff_lastMove_motion_HADNLED_id").innerHTML = Date.now()-lastMove_motion_HANDLED;  
            updateFieldIfNotNull('Accelerometer_x_HANDLED', event.acceleration.x);
            updateFieldIfNotNull('Accelerometer_y_HANDLED', event.acceleration.y);
            updateFieldIfNotNull('Accelerometer_z_HANDLED', event.acceleration.z);
            
            updateFieldIfNotNull('Rotation_b_HANDLED', event.rotationRate.beta);
            updateFieldIfNotNull('Rotation_g_HANDLED', event.rotationRate.gamma);
            updateFieldIfNotNull('Rotation_a_HANDLED', event.rotationRate.alpha);
            lastMove_motion_HANDLED = Date.now();
         }
      }
      </script>
      



      <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
      <script src="https://richtr.github.io/NoSleep.js/dist/NoSleep.min.js"></script>
      <script>
         var noSleep = new NoSleep();
         
         var wakeLockEnabled = false;
         document.addEventListener('click', function() {
             noSleep.enable(); // keep the screen on!
             wakeLockEnabled = true;
             document.body.style.backgroundColor = "green";
         }, false);
      </script>
      <script>
         const url = "https://relay.equilibrium.fabianvillena.tk/socket/equilibrium?api_key=Gato"
         
         function post_to_relay(data) {
         
         $.ajax({
         type: "POST",
         url: url,
         data: data
         });         
         }
         
         var lastMove_orientation_enviar = 0;//No se como es la dinamica de esta variable
         function handleOrientation_Enviar(event) {
            incrementEventCount();            
            if(Date.now() - lastMove_orientation_enviar > 1000) {
               var orientation = {
                  'alpha':event.alpha,
                  'beta':event.beta,
                  'gamma':event.gamma
               }
               console.log(orientation)
               post_to_relay({'orientation':orientation})               
               lastMove_orientation_enviar = Date.now();
               incrementHandledCount();
            }
         }

         var lastMove_motion_enviar = 0;
         function handleMotion_Enviar(event) {   
            incrementEventCount();           
            if(Date.now() - lastMove_motion_enviar > 1000) {
               var motion = {
                  'acceleration_x':event.acceleration.x,
                  'acceleration_y':event.acceleration.y,
                  'acceleration_z':event.acceleration.z,
                  'rotation_alpha':event.rotationRate.alpha,
                  'rotation_beta':event.rotationRate.beta,
                  'rotation_gamma':event.rotationRate.gamma,
               }            
               console.log(motion)
               post_to_relay({'motion':motion})               
               lastMove_motion_enviar = Date.now();
               incrementHandledCount();
            }
         }

         function incrementEventCount(){//CONTADOR DE DATOS
         let counterElement = document.getElementById("num-observed-events")
         let eventCount = parseInt(counterElement.innerHTML)
         counterElement.innerHTML = eventCount + 1;
         }

         function incrementHandledCount(){//CONTADOR DE DATOS HANDLED
         let counterElement = document.getElementById("num-handled-events")
         let eventCount = parseInt(counterElement.innerHTML)
         counterElement.innerHTML = eventCount + 1;
         }

         function handleClick(event) {//Agregada por Víctor
         //document.body.style.backgroundColor = "red"
         alert({'click':clicks});
         var clicks = {
             'clickIzquierdo':"UnClick",
         }
         console.log(click)
         post_to_relay({'click':clicks})         
         }


         
         window.addEventListener("deviceorientation", handleOrientation_Enviar, true);
         window.addEventListener("devicemotion", handleMotion_Enviar, true);
         window.addEventListener("click", handleClick, true)//Agregada por Víctor

         window.addEventListener("deviceorientation", handleOrientationWriteListener, true);//Agregada por Víctor
         window.addEventListener("devicemotion", handleMotionWriteListener, true);//Agregada por Víctor

         window.addEventListener("deviceorientation", handleOrientationWriteListener_HANDLED, true);//Agregada por Víctor
         window.addEventListener("devicemotion", handleMotionWriteListener_HANDLED, true);//Agregada por Víctor

      </script>
   </body>
</html>